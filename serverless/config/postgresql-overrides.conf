# pg_deeplake serverless overrides
# Local disk is ephemeral — optimize for speed, not durability

# WAL — minimal for non-replicated ephemeral instances
wal_level = minimal
max_wal_senders = 0
fsync = off
full_page_writes = off
synchronous_commit = off

# Memory
shared_buffers = 512MB
work_mem = 2GB
maintenance_work_mem = 512MB
effective_cache_size = 4GB

# Connections
max_connections = 200

# Background writer — aggressive flush for COPY workloads
bgwriter_lru_maxpages = 1000
bgwriter_lru_multiplier = 4.0

# Checkpoints — infrequent (data lives in S3)
checkpoint_timeout = 30min
max_wal_size = 4GB

# Logging
log_min_duration_statement = 1000
log_statement = 'ddl'
log_line_prefix = '%m [%p] db=%d user=%u app=%a client=%h '
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on

# Query performance tracking
shared_preload_libraries = 'pg_deeplake,pg_stat_statements'
pg_stat_statements.track = all

# Credentials loaded from tmpfs (never on persistent storage)
include_if_exists = '/dev/shm/deeplake-creds.conf'
